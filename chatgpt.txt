æˆ‘ç¾åœ¨æœ‰å€‹è³‡æ–™çµæ§‹çš„å•é¡Œ,éœ€è¦ä½ çµ¦æˆ‘æ„è¦‹ VButtonListæ˜¯æœ€ä¸Šå±¤çš„é é¢,å®ƒè£¡é¢å€‹å­çµ„ä»¶CanvasViewer, è€Œ 
å®ƒè£¡é¢å€‹å­çµ„ä»¶CanvasViewerè£¡çš„è³‡æ–™æœƒå¾src\stores\signature.jså»å–å¾—,ä¸¦ä¸”appendåˆ°htmlè£¡
ç”±æ–¼æˆ‘çš„å°ˆæ¡ˆè£¡åœ¨VButtonListé é¢è£¡æœƒæœ‰ä¸åŒé¡å‹çš„æ–‡ä»¶è³‡æ–™ï¼Œä¾‹å¦‚æˆ‘ç¾åœ¨æ”¾åœ¨storeè£¡çš„policyholderSignatureã€salesDocPreviewã€salesDocSignature
é‚£æˆ‘å¸Œæœ›ä¸€é–‹å§‹æˆ‘çš„CanvasViewer å®ƒæ‰€appendçš„è³‡æ–™æ˜¯policyholderSignatureç„¶å¾Œç­‰allSignatureCompleteéƒ½ç‚ºtrueçš„æ™‚å€™,VButtonList.vueæ‰å¯ä»¥æŒ‰ä¸‹ä¸€æ­¥, 
ä¸‹ä¸€æ­¥å¾ŒCanvasViewerè£¡å®ƒappendçš„è³‡æ–™å‰‡è®ŠæˆsalesDocPreview,ç„¶å¾Œç­‰salesDocPreviewè£¡çš„readCompleteéƒ½ç‚ºtrueæ™‚,,VButtonList.vueæ‰å¯ä»¥å†æŒ‰ä¸‹ä¸€æ­¥
ä¸‹ä¸€æ­¥å¾ŒCanvasViewerè£¡å®ƒappendçš„è³‡æ–™å‰‡è®ŠæˆsalesDocSignature,ç„¶å¾Œç­‰salesDocSignatureè£¡çš„allSignatureCompleteéƒ½ç‚ºtrueæ™‚,VButtonList.vueæ‰å¯ä»¥å†æŒ‰ä¸‹ä¸€æ­¥

ä¸‹é¢æ˜¯3å€‹æª”æ¡ˆçš„ç¨‹å¼ç¢¼, ä¸Šé¢çš„èªªæ˜ä¸çŸ¥é“ä½ æ¸…ä¸æ¸…æ¥š,æˆ‘æ­£åœ¨æ€è€ƒè¦æ€éº¼å»åšé€™æ¨£çš„çµæ§‹,ä½ èªç‚ºæˆ‘åˆ†åˆ¥æ‹†åˆ†VButtonList1ã€VButtonList2ã€VButtonList3å€‹routeré é¢ä¾†åš(é€™æ¨£åšæˆ‘èªå¯èƒ½æ¯”è¼ƒç°¡å–®é»)
é‚„æ˜¯èªªå¯ä»¥ä¾æˆ‘ç›®å‰çš„çµæ§‹,æˆ‘ä¸€æ¨£å¯ä»¥å…±ç”¨VButtonListé€™å€‹è·¯ç”±é é¢ã€ä¸€æ¨£å¯ä»¥å…±ç”¨CanvasViewerçš„å­çµ„ä»¶ã€åŠstore signature, åªæ˜¯é€™æ¨£æˆ‘çš„é‚è¼¯å°±è¦å¯«çš„å¾ˆæ¸…æ¥šä¹Ÿè¦æ‹†çš„ä¹¾æ·¨, ä½†é€™é›£åº¦æ¯”è¼ƒé«˜
æ‰€ä»¥æˆ‘æƒ³è½è½ä½ çš„æ„è¦‹,ä¸¦çµ¦æˆ‘åˆé©çš„ç­”æ¡ˆåŠåšæ³•


æª”æ¡ˆä¸€src\views\Front-stage\VButtonList.vue
<script setup>
import { onMounted, ref, watch } from 'vue';
import { useInsureanceStore } from '@/stores/signature';
import SwitchSideBarRead from '@/components/signature/SwitchSideBar-Read.vue';
import CanvasViewer from '@/components/signature/CanvasViewer.vue';
import { useMediaCheck } from '@/composable/useMediaCheck';

const store = useInsureanceStore();
const scrollContainerRef = ref(null);
const maxHeight = ref(450);
const { isTablet } = useMediaCheck();
const DataLenght = store.salesDocPreview.length;
console.log(isTablet => , isTablet.value);

function detectBottom(event) {
  if (!(event.target instanceof HTMLElement)) return;
  const { scrollTop, scrollHeight, clientHeight } = event.target;
  const scrollPosition = scrollTop + clientHeight;

  let cumulativeHeight = 0;

  if (scrollHeight <= clientHeight + 1) return;

  store.salesDocPreview.forEach((doc, index) => {
    const pageHeight = doc.pageHeight || 0;
    const pageTop = cumulativeHeight;
    let pageBottom = cumulativeHeight + pageHeight;

    // âœ… åˆ¤æ–·ç›®å‰æ˜¯å¦åœ¨é€™ä¸€é çš„å¯è¦–ç¯„åœå…§
    const isInView = scrollTop >= pageTop && scrollTop < pageBottom;

    // âœ… åˆ¤æ–·æ˜¯å¦ç®—ã€Œå·²çœ‹å®Œã€
    const isRead = scrollPosition >= pageBottom && !doc.readComplete;
    //ç›®å‰æ»¾è¼ªåœ¨è©²é , ä¸”æ»‘åˆ°è©²é é åº•æ‰ç®—å·´å·²é–±è®€

    if (isRead && store.currentPage === index) {
      doc.readComplete = true;
      console.log(âœ… ç¬¬ ${index + 1} é å·²é–±è®€å®Œç•¢);
    }

    if (isInView) {
      if (store.currentPage !== index) {
        store.currentPage = index;
        console.log(ğŸ‘‰ ç¾åœ¨ä½æ–¼ç¬¬ ${index + 1} é );
      }
    }

    cumulativeHeight += pageHeight;
  });
}

function nextStep() {
  const el = scrollContainerRef.value?.$el;
  el.removeEventListener('scroll', detectBottom);
  alert('ä¸‹ä¸€æ­¥');
}

onMounted(() => {
  const el = scrollContainerRef.value?.$el;
  if (el instanceof HTMLElement) {
    el.addEventListener('scroll', detectBottom);
    maxHeight.value = screen.availHeight * 0.61;
    store.setScrollContainer(el);
  } else return;
});

watch(
  () => store.currentPage,
  () => {
    const el = scrollContainerRef.value?.$el;
    if (el instanceof HTMLElement) {
      el.removeEventListener('scroll', detectBottom);
    }
    requestAnimationFrame(() => {
      el.addEventListener('scroll', detectBottom);
    });
  }
);
</script>

<template>
  <v-container fluid="">
    <!-- åç¨±åˆ— & é æ•¸ -->
    <v-row>
      <v-col cols="1" class="pa-0 text-center align-self-center">
        <v-icon icon="mdi-chevron-left" color="grey-darken-1" size="30"></v-icon>
      </v-col>
      <v-col cols="11">
        <div class="d-flex bgPrimaryColor justify-space-between align-center">
          <p class="text-grey-darken-3">è¦ä¿äººåŒæ„æ›¸</p>
          <p class="text-grey-darken-3 pr-2">ç¸½é æ•¸10é </p>
        </div>
      </v-col>
    </v-row>
    <v-row>
      <!-- åˆ‡æ›é ç±¤æŒ‰éˆ• -->
      <v-col cols="1" class="pa-0">
        <SwitchSideBarRead />
      </v-col>

      <!-- ä¿æ›¸ã€åˆç´„æ›¸å…§å®¹ -->
      <v-col cols="11">
        <v-sheet class="bgPrimaryColor position-relative">
          <v-sheet
            ref="scrollContainerRef"
            class="d-flex justify-center bg-transparent overflow-auto"
            :max-height="maxHeight"
          >
            <v-sheet class="position-absolute top-0 left-0 w-100" color="transparent">
              <!-- <SignaturedNavbar /> -->
            </v-sheet>
            <div>
              <CanvasViewer />
            </div>
          </v-sheet>
        </v-sheet>

        <!-- ä¸‹ä¸€æ­¥æŒ‰éˆ• -->
        <v-layout row wrap class="justify-center mt-5">
          <v-btn
            density="comfortable"
            color="blue-darken-4"
            size="x-large"
            class="bg-white mr-5"
            variant="text"
            width="250"
            >å„²å­˜
          </v-btn>
          <v-btn
            density="comfortable"
            color="white"
            size="x-large"
            width="250"
            class="bg-blue-darken-4"
            :disabled="!store.nextButton"
            @click="nextStep"
            >ä¸‹ä¸€æ­¥
          </v-btn>
        </v-layout>
      </v-col>
    </v-row>
  </v-container>
</template>

<style lang="scss" scoped>
.bgPrimaryColor {
  background-color: #f2f6ff;
}

.step--completed {
  border: 2px solid rgba(var(--v-theme-primary), 1);
}

.step--editing {
  border: 2px solid rgba(var(--v-theme-secondary), 1);
}
</style>

src\components\signature\CanvasViewer.vue
<script setup>
import { onMounted, ref, watch, nextTick } from 'vue';
import { useInsureanceStore } from '@/stores/signature';

const store = useInsureanceStore();
const canvasRef = ref(null);

// é¦–æ¬¡æ›è¼‰æ™‚ä¹Ÿæ›´æ–°ä¸€æ¬¡ç•«å¸ƒ
onMounted(async () => {
  canvasRef.value.innerHTML = '';
  for (let i = 0; i < store.salesDocPreview.length; i++) {
    const canvas = await store.renderInsureanceDoc(i);
    if (canvas) {
      canvasRef.value.appendChild(canvas);
      const domHeight = canvas.offsetHeight;
      store.salesDocPreview[i].pageHeight = domHeight;
      console.log(ğŸ“ ç¬¬ ${i + 1} é  DOM é«˜åº¦ç‚º ${domHeight}px);
    }
  }
});
</script>

<template>
  <v-sheet class="d-flex justify-center align-center">
    <v-progress-circular
      color="grey-darken-1"
      indeterminate
      size="40"
      v-show="store.isLoading"
    ></v-progress-circular>
  </v-sheet>

  <div ref="canvasRef" v-show="!store.isLoading" class="canvas-container border-xl"></div>
</template>

<style lang="scss" scoped>
.canvas-container :deep(canvas) {
  max-width: 100%;
  border-bottom: 5px solid rgba(0, 0, 0, 0.2);
  display: block;
  margin: auto;
}
</style>

æª”æ¡ˆäºŒsrc\components\signature\CanvasViewer.vue

<script setup>
import { onMounted, ref, watch, nextTick } from 'vue';
import { useInsureanceStore } from '@/stores/signature';

const store = useInsureanceStore();
const canvasRef = ref(null);

// é¦–æ¬¡æ›è¼‰æ™‚ä¹Ÿæ›´æ–°ä¸€æ¬¡ç•«å¸ƒ
onMounted(async () => {
  canvasRef.value.innerHTML = '';
  for (let i = 0; i < store.salesDocPreview.length; i++) {
    const canvas = await store.renderInsureanceDoc(i);
    if (canvas) {
      canvasRef.value.appendChild(canvas);
      const domHeight = canvas.offsetHeight;
      store.salesDocPreview[i].pageHeight = domHeight;
      console.log(ğŸ“ ç¬¬ ${i + 1} é  DOM é«˜åº¦ç‚º ${domHeight}px);
    }
  }
});
</script>

<template>
  <v-sheet class="d-flex justify-center align-center">
    <v-progress-circular
      color="grey-darken-1"
      indeterminate
      size="40"
      v-show="store.isLoading"
    ></v-progress-circular>
  </v-sheet>

  <div ref="canvasRef" v-show="!store.isLoading" class="canvas-container border-xl"></div>
</template>

<style lang="scss" scoped>
.canvas-container :deep(canvas) {
  max-width: 100%;
  border-bottom: 5px solid rgba(0, 0, 0, 0.2);
  display: block;
  margin: auto;
}
</style>

æª”æ¡ˆä¸‰ src\stores\signature.js
import { defineStore } from 'pinia';
import { computed, ref } from 'vue';
import { fromArrayBuffer } from 'geotiff'

export const useInsureanceStore = defineStore('insureance', () => {
  const policyholderSignature = ref([
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸1',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººç°½å',
          cordinate: { x: 522, y: 266 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¢«ä¿éšªäººç°½å',
          cordinate: { x: 522, y: 346 },
          isSinged: true
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'æ³•å®šä»£ç†äººç°½å',
          cordinate: { x: 655, y: 443 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'é—œä¿‚',
          cordinate: { x: 1064, y: 449 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¢«ä¿éšªäººé…å¶ç°½å',
          cordinate: { x: 522, y: 224 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¢«ä¿éšªäººå­å¥³ç°½å',
          cordinate: { x: 522, y: 274 },
          isSinged: false
        }
      ],
      tiffUrl: '/ag_ieasy_confirm1.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸2',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm2.tiff?url',
      isSignaturing: true,
      allSignatureComplete: true
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸3',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm3.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸4',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm4.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸5',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm5.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸5',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm6.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸5',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm7.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    }
  ]);

  const salesDocPreview = ref([
    {
      type: 'read',
      salseDocId: Math.floor(Math.random() * 10000),
      title: 'æ¥­å‹™æ›¸1',
      tiffUrl: '/ag_ieasy_confirm.tiff',
      readComplete: false,
      pageHeight: 0
    },
    {
      type: 'read',
      salseDocId: Math.floor(Math.random() * 10000),
      title: 'æ¥­å‹™æ›¸2',
      tiffUrl: '/ag_ieasy_confirm2.tiff',
      readComplete: false,
      pageHeight: 0
    },
    {
      type: 'read',
      salseDocId: Math.floor(Math.random() * 10000),
      title: 'æ¥­å‹™æ›¸3',
      tiffUrl: '/ag_ieasy_confirm3.tiff',
      readComplete: false,
      pageHeight: 0
    },
  ])

  const salesDocSignature = ref([
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸1',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººç°½å',
          cordinate: { x: 522, y: 266 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¢«ä¿éšªäººç°½å',
          cordinate: { x: 522, y: 346 },
          isSinged: true
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'æ³•å®šä»£ç†äººç°½å',
          cordinate: { x: 655, y: 443 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'é—œä¿‚',
          cordinate: { x: 1064, y: 449 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¢«ä¿éšªäººé…å¶ç°½å',
          cordinate: { x: 522, y: 224 },
          isSinged: false
        },
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¢«ä¿éšªäººå­å¥³ç°½å',
          cordinate: { x: 522, y: 274 },
          isSinged: false
        }
      ],
      tiffUrl: '/ag_ieasy_confirm1.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸2',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm2.tiff?url',
      isSignaturing: true,
      allSignatureComplete: true
    },
    {
      type: 'sign',
      insueranceId: Math.floor(Math.random() * 10000),
      title: 'è¦ä¿æ›¸3',
      signature: [
        {
          sinatureId: Math.floor(Math.random() * 10000),
          signatureTitle: 'è¦ä¿äººåŒæ„åŒæŠ•ä¿',
          cordinate: { x: 100, y: 200 },
          isSinged: true
        }
      ],
      tiffUrl: '/ag_ieasy_confirm3.tiff?url',
      isSignaturing: true,
      allSignatureComplete: false
    },
  ])


  const currentPage = ref(0);
  const renderedCanvas = ref(null);
  const isLoading = ref(true)
  const scrollContainerRef = ref(null);
  const nextButton = computed(() =>
    salesDocPreview.value.every(doc => doc.readComplete === true)
  );

  function setScrollContainer(el) {
    scrollContainerRef.value = el;
  }

  async function renderInsureanceDoc(page) {
    const currentDoc = salesDocPreview.value[page];
    if (!currentDoc || !currentDoc.tiffUrl) {
      renderedCanvas.value = null;
      return null;
    }

    try {
      isLoading.value = true
      const response = await fetch(currentDoc.tiffUrl)
      const arrayBuffer = await response.arrayBuffer()
      const tiff = await fromArrayBuffer(arrayBuffer)
      const image = await tiff.getImage();
      const raster = await image.readRasters({ interleave: true });
      const canvas = document.createElement('canvas');
      const width = image.getWidth();
      const height = image.getHeight();
      const ctx = canvas.getContext('2d');
      const imageData = ctx.createImageData(width, height);

      canvas.width = width;
      canvas.height = height;
      // salesDocPreview.value[page].pageHeight = height

      for (let i = 0; i < width * height; i++) {
        const r16 = raster[i * 4];
        const g16 = raster[i * 4 + 1];
        const b16 = raster[i * 4 + 2];
        const a16 = raster[i * 4 + 3];

        const r = (r16 * 255) / 65535;
        const g = (g16 * 255) / 65535;
        const b = (b16 * 255) / 65535;
        const a = (a16 * 255) / 65535;

        imageData.data[i * 4] = r;
        imageData.data[i * 4 + 1] = g;
        imageData.data[i * 4 + 2] = b;
        imageData.data[i * 4 + 3] = a;
      }

      ctx.putImageData(imageData, 0, 0);
      // renderedCanvas.value = canvas;
      isLoading.value = false
      return canvas;
    } catch (error) {
      isLoading.value = false
      console.error('æ¸²æŸ“ TIFF å¤±æ•—:', error);

      return null;
    }
  }


  async function switchPage({ index = currentPage.value, type = '' }) {
    isLoading.value = false
    if (type === 'last' && currentPage.value === 0) return;
    if (type === 'next' && currentPage.value === salesDocPreview.value.length - 1) return;

    // if (type === 'next') {
    //   currentPage.value++;
    // } else if (type === 'last') {
    //   currentPage.value--;
    // } else if (index !== currentPage.value) {
    // }
    currentPage.value = index;
    scrollToPage(currentPage.value);
    //éœ€å·²é–±è®€æ‰èƒ½è·³é 
    // if (salesDocPreview.value[currentPage.value].readComplete) {
    //   currentPage.value = index;
    //   scrollToPage(currentPage.value);
    // }
  }

  function scrollToPage(pageIndex) {

    const el = scrollContainerRef.value?.$el || scrollContainerRef.value;
    if (!(el instanceof HTMLElement)) return;

    let targetTop = 0;

    for (let i = 0; i < pageIndex; i++) {
      const height = salesDocPreview.value[i]?.pageHeight || 0;
      targetTop += height;
    }

    el.scrollTo({
      top: targetTop,
      behavior: 'auto'
    });


    console.log(ğŸ” æ»¾å‹•è‡³ç¬¬ ${pageIndex + 1} é ï¼Œä½ç½® ${targetTop}px);
  }

  return {
    policyholderSignature,
    currentPage,
    switchPage,
    renderInsureanceDoc,
    salesDocPreview,
    renderedCanvas,
    isLoading,
    scrollContainerRef,
    setScrollContainer,
    scrollToPage,
    nextButton
  };
});